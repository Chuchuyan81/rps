<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç –û—Ç–ª–∞–¥–∫–∞ Supabase</title>
    <style>
        body { font-family: monospace; background: #1a1a1a; color: #0f0; padding: 20px; }
        .test { background: #2a2a2a; border: 1px solid #444; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: #0f0; } .error { color: #f00; } .warning { color: #ff0; } .info { color: #0af; }
        button { background: #333; color: #0f0; border: 1px solid #0f0; padding: 10px 20px; margin: 5px; cursor: pointer; border-radius: 3px; }
        button:hover { background: #0f0; color: #000; }
        .log { background: #000; padding: 10px; margin: 10px 0; border-radius: 3px; max-height: 300px; overflow-y: auto; font-size: 12px; }
        .code { background: #333; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h1>
    
    <div class="test">
        <h3>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏:</h3>
        <div class="code">
            window.supabaseClient - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç<br>
            window.testSupabase() - –±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è<br>
            window.createTestRoom() - —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–æ–º–Ω–∞—Ç—ã<br>
            window.debugInfo() - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        </div>
    </div>

    <div class="test">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h3>
        <div id="lib-status">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button onclick="checkLib()">üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>

    <div class="test">
        <h3>2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞</h3>
        <div id="client-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <button onclick="initClient()">üîå –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="test">
        <h3>3. –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
        <div id="conn-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <button onclick="testConn()">üåê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <div class="test">
        <h3>4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü—ã</h3>
        <div id="table-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <button onclick="checkTable()">üìä –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    </div>

    <div class="test">
        <h3>5. –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã</h3>
        <div id="room-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>
        <button onclick="testRoom()">üè† –°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div class="test">
        <h3>üìù –õ–æ–≥–∏</h3>
        <button onclick="clearLogs()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        <div class="log" id="logs"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = "https://kdbbyqsdmucjvsatbiog.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtkYmJ5cXNkbXVjanZzYXRiaW9nIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0MzQxNzcsImV4cCI6MjA2NjAxMDE3N30.v6wR9s1zCyYL-xN2Rohoi35LJ-f1uA1Y5KPPjQoXhLU";
        
        let supabaseClient = null;

        function log(msg, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const cls = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logs.innerHTML += `<div class="${cls}">[${time}] ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${time}] ${msg}`);
        }

        function setStatus(id, msg, type = 'info') {
            const el = document.getElementById(id);
            const cls = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            el.innerHTML = `<span class="${cls}">${msg}</span>`;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function checkLib() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Supabase...');
            if (typeof window.supabase === 'undefined') {
                log('‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Supabase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!', 'error');
                setStatus('lib-status', '‚ùå –ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error');
                return false;
            }
            if (typeof window.supabase.createClient !== 'function') {
                log('‚ùå createClient –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞!', 'error');
                setStatus('lib-status', '‚ùå createClient –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return false;
            }
            log('‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            setStatus('lib-status', '‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
            return true;
        }

        function initClient() {
            log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç...');
            if (!checkLib()) return false;

            try {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey, {
                    auth: { autoRefreshToken: true, persistSession: false },
                    realtime: { params: { eventsPerSecond: 10 } }
                });

                // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ
                window.supabaseClient = supabaseClient;

                log('‚úÖ –ö–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                setStatus('client-status', '‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');
                
                // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ö–µ–ª–ø–µ—Ä—ã
                window.testSupabase = async () => {
                    if (!window.supabaseClient) {
                        console.error('‚ùå –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                        return { error: 'Client not initialized' };
                    }
                    try {
                        const { data, error } = await window.supabaseClient.from('games').select('count').limit(1);
                        console.log('‚úÖ –¢–µ—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', { data, error });
                        return { data, error };
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞:', e);
                        return { error: e };
                    }
                };

                window.createTestRoom = async () => {
                    if (!window.supabaseClient) {
                        console.error('‚ùå –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                        return { error: 'Client not initialized' };
                    }
                    const roomId = 'TEST_' + Math.random().toString(36).substr(2, 6);
                    try {
                        const { data, error } = await window.supabaseClient
                            .from('games')
                            .insert([{ room_id: roomId, player1_id: 'test_player', status: 'waiting_player2' }])
                            .select().single();
                        console.log('‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞:', { data, error });
                        return { data, error };
                    } catch (e) {
                        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è:', e);
                        return { error: e };
                    }
                };

                window.debugInfo = () => {
                    const info = {
                        hasClient: !!window.supabaseClient,
                        url: supabaseUrl,
                        keyLength: supabaseKey.length
                    };
                    console.log('‚ÑπÔ∏è Debug info:', info);
                    return info;
                };

                log('‚úÖ –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã', 'success');
                return true;
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                setStatus('client-status', `‚ùå ${error.message}`, 'error');
                return false;
            }
        }

        async function testConn() {
            log('–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            if (!supabaseClient) {
                if (!initClient()) return;
            }

            try {
                const { data, error } = await supabaseClient.from('games').select('count').limit(1);
                if (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    setStatus('conn-status', `‚ùå ${error.message}`, 'error');
                    return false;
                }
                log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ', 'success');
                setStatus('conn-status', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –û–ö', 'success');
                return true;
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
                setStatus('conn-status', `‚ùå ${error.message}`, 'error');
                return false;
            }
        }

        async function checkTable() {
            log('–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∞–±–ª–∏—Ü—É games...');
            if (!supabaseClient) {
                log('‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'warning');
                return;
            }

            try {
                const { data, error } = await supabaseClient.from('games').select('*').limit(1);
                if (error) {
                    if (error.code === '42P01') {
                        log('‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!', 'error');
                        setStatus('table-status', '‚ùå –¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                    } else {
                        log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                        setStatus('table-status', `‚ùå ${error.message}`, 'error');
                    }
                    return false;
                }
                log('‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'success');
                setStatus('table-status', '‚úÖ –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞', 'success');
                return true;
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
                setStatus('table-status', `‚ùå ${error.message}`, 'error');
                return false;
            }
        }

        async function testRoom() {
            log('–°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –∫–æ–º–Ω–∞—Ç—É...');
            if (!supabaseClient) {
                log('‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'warning');
                return;
            }

            const testRoomId = 'DEBUG_' + Math.random().toString(36).substr(2, 6);
            try {
                const { data, error } = await supabaseClient
                    .from('games')
                    .insert([{
                        room_id: testRoomId,
                        player1_id: 'debug_player',
                        status: 'waiting_player2'
                    }])
                    .select().single();

                if (error) {
                    log(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
                    setStatus('room-status', `‚ùå ${error.message}`, 'error');
                    return false;
                }

                log(`‚úÖ –ö–æ–º–Ω–∞—Ç–∞ ${data.room_id} —Å–æ–∑–¥–∞–Ω–∞`, 'success');
                setStatus('room-status', `‚úÖ ${data.room_id} —Å–æ–∑–¥–∞–Ω–∞`, 'success');

                // –£–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                setTimeout(async () => {
                    try {
                        await supabaseClient.from('games').delete().eq('room_id', testRoomId);
                        log(`üóëÔ∏è –ö–æ–º–Ω–∞—Ç–∞ ${testRoomId} —É–¥–∞–ª–µ–Ω–∞`, 'info');
                    } catch (e) {
                        log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ${e.message}`, 'warning');
                    }
                }, 10000);

                return true;
            } catch (error) {
                log(`‚ùå –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ${error.message}`, 'error');
                setStatus('room-status', `‚ùå ${error.message}`, 'error');
                return false;
            }
        }

        // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ –ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...');
            setTimeout(() => {
                checkLib();
                setTimeout(() => {
                    if (checkLib()) initClient();
                }, 500);
            }, 100);
        });
    </script>
</body>
</html> 